<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªçc T·ª´ V·ª±ng - Cloud Sync</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        
        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #6B8DD6 100%);
            padding: 20px;
        }
        
        .container { max-width: 900px; margin: 0 auto; }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            animation: fadeIn 0.8s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .header h1 { font-size: 2.2rem; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .header p { opacity: 0.9; font-size: 1rem; }
        
        .storage-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-top: 12px;
        }
        
        .storage-badge.connected { background: rgba(76, 175, 80, 0.3); }
        .storage-badge.disconnected { background: rgba(244, 67, 54, 0.3); }
        .storage-badge.syncing { background: rgba(255, 193, 7, 0.3); }
        
        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
        }
        
        .dot.disconnected { background: #f44336; }
        .dot.syncing { background: #FFC107; animation: pulse 1s infinite; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .card {
            background: rgba(255,255,255,0.97);
            border-radius: 24px;
            padding: 28px;
            margin-bottom: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            animation: slideUp 0.5s ease;
        }
        
        .card-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .btn-secondary:hover { background: #e0e0e0; }
        
        .btn-danger {
            background: #ff5252;
            color: white;
            padding: 8px 12px;
        }
        
        .btn-danger:hover { background: #ff1744; }
        
        .btn-audio {
            background: linear-gradient(135deg, #00b4db, #0083b0);
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .input-field {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin-bottom: 16px;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }
        
        .upload-zone {
            border: 3px dashed #d0d0d0;
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 16px;
        }
        
        .upload-zone:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }
        
        .upload-zone.has-file {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.05);
        }
        
        .upload-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .upload-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        @media (max-width: 600px) {
            .upload-grid { grid-template-columns: 1fr; }
        }
        
        .vocab-sets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 16px;
        }
        
        .vocab-set-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .vocab-set-card:hover {
            border-color: #667eea;
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .vocab-set-card.active {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        }
        
        .vocab-set-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }
        
        .vocab-set-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: #333;
        }
        
        .vocab-set-count {
            color: #666;
            font-size: 0.9rem;
        }
        
        /* Flashcard */
        .flashcard-container {
            perspective: 1000px;
            margin-bottom: 24px;
        }
        
        .flashcard {
            position: relative;
            width: 100%;
            height: 320px;
            cursor: pointer;
            transform-style: preserve-3d;
            transition: transform 0.6s ease;
        }
        
        .flashcard.flipped { transform: rotateY(180deg); }
        
        .flashcard-face {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px;
            backface-visibility: hidden;
            text-align: center;
        }
        
        .flashcard-front {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .flashcard-back {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
            transform: rotateY(180deg);
        }
        
        .word-english {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 12px;
        }
        
        .word-pos {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .word-pronunciation {
            font-size: 1.1rem;
            font-style: italic;
            opacity: 0.85;
        }
        
        .word-vietnamese {
            font-size: 2rem;
            font-weight: 600;
            margin-top: 16px;
        }
        
        .flip-hint {
            position: absolute;
            bottom: 20px;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }
        
        .controls-center {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }
        
        .progress-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }
        
        .empty-icon {
            font-size: 5rem;
            margin-bottom: 20px;
        }
        
        .empty-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 12px;
        }
        
        .empty-desc {
            color: #666;
            margin-bottom: 24px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #6B8DD6 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 1000;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .config-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
        }
        
        .config-title {
            font-weight: 700;
            color: #856404;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .config-grid {
            display: grid;
            gap: 12px;
        }
        
        .config-input {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .config-input label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #666;
        }
        
        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }
        
        .hidden { display: none !important; }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1002;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            width: 100%;
            max-width: 450px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-header h3 {
            font-size: 1.2rem;
            color: #333;
        }
        
        .btn-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            padding: 0;
            line-height: 1;
        }
        
        .btn-close:hover { color: #333; }
        
        .modal-body {
            padding: 24px;
        }
        
        .current-config {
            background: #e3f2fd;
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        
        .config-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tab-btn:hover { border-color: #667eea; }
        
        .tab-btn.active {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            color: #667eea;
        }
        
        .tab-content { animation: fadeIn 0.3s ease; }
        
        .danger-zone {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 14px 28px;
            border-radius: 12px;
            font-weight: 500;
            z-index: 1001;
            animation: toastIn 0.3s ease;
        }
        
        .toast.success { background: #4CAF50; }
        .toast.error { background: #f44336; }
        
        @keyframes toastIn {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
    </style>
</head>
<body>
    <div id="loading" class="loading-overlay">
        <div class="spinner"></div>
        <div style="font-size: 1.3rem; font-weight: 600;">ƒêang k·∫øt n·ªëi...</div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üìö H·ªçc T·ª´ V·ª±ng</h1>
            <p>Flashcard th√¥ng minh - ƒê·ªìng b·ªô m·ªçi thi·∫øt b·ªã</p>
            <div id="storage-status" class="storage-badge disconnected" onclick="showConfigModal()" style="cursor: pointer;" title="Click ƒë·ªÉ thay ƒë·ªïi c·∫•u h√¨nh">
                <span class="dot disconnected"></span>
                <span>ƒêang k·∫øt n·ªëi...</span>
                <span style="margin-left: 4px;">‚öôÔ∏è</span>
            </div>
        </div>

        <!-- Firebase Config Section -->
        <div id="config-section" class="card config-section hidden">
            <div class="config-title">
                ‚öôÔ∏è C·∫•u h√¨nh Firebase (Ch·ªâ c·∫ßn l√†m 1 l·∫ßn)
            </div>
            <p style="color: #666; margin-bottom: 16px; font-size: 0.9rem;">
                ƒê·ªÉ l∆∞u tr·ªØ d·ªØ li·ªáu vƒ©nh vi·ªÖn tr√™n cloud, b·∫°n c·∫ßn t·∫°o project Firebase mi·ªÖn ph√≠.
                <a href="https://console.firebase.google.com/" target="_blank" style="color: #667eea;">T·∫°o t·∫°i ƒë√¢y</a>
            </p>
            <div class="config-grid">
                <div class="config-input">
                    <label>API Key</label>
                    <input type="text" id="cfg-apiKey" class="input-field" placeholder="AIzaSy..." style="margin-bottom: 0;">
                </div>
                <div class="config-input">
                    <label>Project ID</label>
                    <input type="text" id="cfg-projectId" class="input-field" placeholder="my-vocab-app" style="margin-bottom: 0;">
                </div>
                <div class="config-input">
                    <label>Database URL</label>
                    <input type="text" id="cfg-databaseURL" class="input-field" placeholder="https://my-vocab-app-default-rtdb.firebaseio.com" style="margin-bottom: 0;">
                </div>
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="saveFirebaseConfig()">üíæ L∆∞u & K·∫øt n·ªëi</button>
                <button class="btn btn-secondary" onclick="useLocalStorage()">üì± D√πng Local Storage</button>
            </div>
        </div>

        <!-- Upload Section -->
        <div id="upload-section" class="card hidden">
            <div class="card-title">
                <span>‚ú® T·∫°o B·ªô T·ª´ M·ªõi</span>
                <button class="btn btn-secondary" onclick="hideUpload()">‚úï ƒê√≥ng</button>
            </div>
            
            <input type="text" id="set-name" class="input-field" placeholder="T√™n b·ªô t·ª´ (VD: TOEIC 600, IELTS...)">
            
            <div class="upload-grid">
                <div class="upload-zone" id="excel-zone" onclick="document.getElementById('excel-input').click()">
                    <div class="upload-icon">üìÑ</div>
                    <div style="font-weight: 600; color: #333;">File Excel</div>
                    <div id="excel-name" style="color: #667eea; margin-top: 8px; font-size: 0.9rem;">Ch·ªçn file .xlsx</div>
                    <input type="file" id="excel-input" accept=".xlsx,.xls" style="display: none;" onchange="handleExcelSelect(this)">
                </div>
                
                <div class="upload-zone" id="audio-zone" onclick="document.getElementById('audio-input').click()">
                    <div class="upload-icon">üîä</div>
                    <div style="font-weight: 600; color: #333;">File Audio</div>
                    <div id="audio-name" style="color: #667eea; margin-top: 8px; font-size: 0.9rem;">Ch·ªçn files .wav/.mp3</div>
                    <input type="file" id="audio-input" accept=".wav,.mp3" multiple style="display: none;" onchange="handleAudioSelect(this)">
                </div>
            </div>
            
            <button class="btn btn-primary" style="width: 100%; justify-content: center;" onclick="createVocabSet()">
                üöÄ T·∫°o B·ªô T·ª´
            </button>
        </div>

        <!-- Vocab Sets List -->
        <div id="sets-section" class="card hidden">
            <div class="card-title">
                <span>üìñ B·ªô T·ª´ C·ªßa B·∫°n</span>
                <button class="btn btn-primary" onclick="showUpload()">‚ûï Th√™m M·ªõi</button>
            </div>
            <div id="vocab-sets-list" class="vocab-sets-grid"></div>
        </div>

        <!-- Flashcard Section -->
        <div id="flashcard-section" class="hidden">
            <div class="flashcard-container">
                <div id="flashcard" class="flashcard" onclick="flipCard()">
                    <div class="flashcard-face flashcard-front">
                        <div id="fc-english" class="word-english">Hello</div>
                        <div id="fc-pos" class="word-pos">(noun)</div>
                        <div id="fc-pronunciation" class="word-pronunciation">/h…ôÀàlo ä/</div>
                        <div class="flip-hint">üëÜ Nh·∫•n ƒë·ªÉ xem nghƒ©a</div>
                    </div>
                    <div class="flashcard-face flashcard-back">
                        <div id="fc-english-back" class="word-english">Hello</div>
                        <div id="fc-pos-back" class="word-pos">(noun)</div>
                        <div id="fc-pronunciation-back" class="word-pronunciation">/h…ôÀàlo ä/</div>
                        <div id="fc-vietnamese" class="word-vietnamese">Xin ch√†o</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="controls">
                    <button class="btn btn-secondary" id="btn-prev" onclick="prevWord()">
                        ‚óÄ Tr∆∞·ªõc
                    </button>
                    
                    <div class="controls-center">
                        <div id="progress-badge" class="progress-badge">1 / 10</div>
                        <button class="btn btn-audio" onclick="playAudio()">
                            üîä Ph√°t √Çm
                        </button>
                    </div>
                    
                    <button class="btn btn-secondary" id="btn-next" onclick="nextWord()">
                        Sau ‚ñ∂
                    </button>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="card hidden">
            <div class="empty-state">
                <div class="empty-icon">üìö</div>
                <div class="empty-title">Ch∆∞a C√≥ B·ªô T·ª´ N√†o</div>
                <div class="empty-desc">H√£y t·∫°o b·ªô t·ª´ ƒë·∫ßu ti√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu h√†nh tr√¨nh h·ªçc ti·∫øng Anh!</div>
                <button class="btn btn-primary" onclick="showUpload()">‚ú® B·∫Øt ƒê·∫ßu Ngay</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast hidden"></div>

    <!-- Config Modal -->
    <div id="config-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚öôÔ∏è C·∫•u h√¨nh l∆∞u tr·ªØ</h3>
                <button class="btn-close" onclick="hideConfigModal()">‚úï</button>
            </div>
            
            <div class="modal-body">
                <div class="current-config" id="current-config-info">
                    <strong>ƒêang s·ª≠ d·ª•ng:</strong> <span id="current-storage-type">Ch∆∞a c·∫•u h√¨nh</span>
                </div>
                
                <div class="config-tabs">
                    <button class="tab-btn active" onclick="switchTab('firebase')">‚òÅÔ∏è Firebase</button>
                    <button class="tab-btn" onclick="switchTab('local')">üíæ Local Storage</button>
                </div>
                
                <div id="tab-firebase" class="tab-content">
                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 16px;">
                        L∆∞u tr·ªØ tr√™n cloud, ƒë·ªìng b·ªô m·ªçi thi·∫øt b·ªã.
                        <a href="https://console.firebase.google.com/" target="_blank" style="color: #667eea;">T·∫°o Firebase t·∫°i ƒë√¢y</a>
                    </p>
                    <div class="config-input">
                        <label>API Key</label>
                        <input type="text" id="modal-apiKey" class="input-field" placeholder="AIzaSy..." style="margin-bottom: 12px;">
                    </div>
                    <div class="config-input">
                        <label>Project ID</label>
                        <input type="text" id="modal-projectId" class="input-field" placeholder="my-vocab-app" style="margin-bottom: 12px;">
                    </div>
                    <div class="config-input">
                        <label>Database URL</label>
                        <input type="text" id="modal-databaseURL" class="input-field" placeholder="https://xxx.firebaseio.com" style="margin-bottom: 0;">
                    </div>
                    <button class="btn btn-primary" style="width: 100%; margin-top: 16px;" onclick="connectFirebase()">
                        üîó K·∫øt n·ªëi Firebase
                    </button>
                </div>
                
                <div id="tab-local" class="tab-content hidden">
                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 16px;">
                        L∆∞u tr·ªØ tr√™n thi·∫øt b·ªã n√†y. D·ªØ li·ªáu s·∫Ω m·∫•t n·∫øu x√≥a cache tr√¨nh duy·ªát.
                    </p>
                    <button class="btn btn-secondary" style="width: 100%;" onclick="switchToLocal()">
                        üíæ S·ª≠ d·ª•ng Local Storage
                    </button>
                </div>
                
                <div class="danger-zone">
                    <strong style="color: #d32f2f;">‚ö†Ô∏è V√πng nguy hi·ªÉm</strong>
                    <button class="btn btn-danger" style="width: 100%; margin-top: 12px;" onclick="resetAllConfig()">
                        üóëÔ∏è X√≥a c·∫•u h√¨nh & ƒê·∫∑t l·∫°i
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== GLOBAL STATE ====================
        let db = null;
        let vocabSets = [];
        let activeSetId = null;
        let currentIndex = 0;
        let isFlipped = false;
        let excelFile = null;
        let audioFiles = [];
        let useFirebase = false;
        let audioElement = new Audio();

        // ==================== FIREBASE SETUP ====================
        function initFirebase(config) {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(config);
                }
                db = firebase.database();
                useFirebase = true;
                updateStorageStatus('connected', '‚òÅÔ∏è Firebase Cloud - ƒê·ªìng b·ªô m·ªçi thi·∫øt b·ªã');
                return true;
            } catch (error) {
                console.error('Firebase init error:', error);
                return false;
            }
        }

        function saveFirebaseConfig() {
            const config = {
                apiKey: document.getElementById('cfg-apiKey').value.trim(),
                projectId: document.getElementById('cfg-projectId').value.trim(),
                databaseURL: document.getElementById('cfg-databaseURL').value.trim()
            };

            if (!config.apiKey || !config.projectId || !config.databaseURL) {
                showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'error');
                return;
            }

            if (initFirebase(config)) {
                localStorage.setItem('firebaseConfig', JSON.stringify(config));
                document.getElementById('config-section').classList.add('hidden');
                loadVocabSets();
                showToast('K·∫øt n·ªëi Firebase th√†nh c√¥ng!', 'success');
            } else {
                showToast('L·ªói k·∫øt n·ªëi Firebase!', 'error');
            }
        }

        function useLocalStorage() {
            useFirebase = false;
            localStorage.setItem('storageMode', 'local');
            document.getElementById('config-section').classList.add('hidden');
            updateStorageStatus('connected', 'üíæ Local Storage - Ch·ªâ thi·∫øt b·ªã n√†y');
            loadVocabSets();
        }

        // ==================== MODAL FUNCTIONS ====================
        function showConfigModal() {
            const modal = document.getElementById('config-modal');
            modal.classList.remove('hidden');
            
            // Load current config into form
            const savedConfig = localStorage.getItem('firebaseConfig');
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    document.getElementById('modal-apiKey').value = config.apiKey || '';
                    document.getElementById('modal-projectId').value = config.projectId || '';
                    document.getElementById('modal-databaseURL').value = config.databaseURL || '';
                } catch (e) {}
            }
            
            // Update current storage type display
            const storageMode = localStorage.getItem('storageMode');
            const typeSpan = document.getElementById('current-storage-type');
            if (useFirebase) {
                typeSpan.textContent = '‚òÅÔ∏è Firebase Cloud';
                typeSpan.style.color = '#4CAF50';
            } else if (storageMode === 'local') {
                typeSpan.textContent = 'üíæ Local Storage';
                typeSpan.style.color = '#2196F3';
            } else {
                typeSpan.textContent = '‚ö†Ô∏è Ch∆∞a c·∫•u h√¨nh';
                typeSpan.style.color = '#ff9800';
            }
        }
        
        function hideConfigModal() {
            document.getElementById('config-modal').classList.add('hidden');
        }
        
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            
            if (tab === 'firebase') {
                document.querySelector('.tab-btn:first-child').classList.add('active');
                document.getElementById('tab-firebase').classList.remove('hidden');
            } else {
                document.querySelector('.tab-btn:last-child').classList.add('active');
                document.getElementById('tab-local').classList.remove('hidden');
            }
        }
        
        function connectFirebase() {
            const config = {
                apiKey: document.getElementById('modal-apiKey').value.trim(),
                projectId: document.getElementById('modal-projectId').value.trim(),
                databaseURL: document.getElementById('modal-databaseURL').value.trim()
            };

            if (!config.apiKey || !config.projectId || !config.databaseURL) {
                showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'error');
                return;
            }

            // Delete old Firebase app if exists
            if (firebase.apps.length) {
                firebase.apps.forEach(app => app.delete());
            }

            if (initFirebase(config)) {
                localStorage.setItem('firebaseConfig', JSON.stringify(config));
                localStorage.removeItem('storageMode');
                hideConfigModal();
                document.getElementById('config-section').classList.add('hidden');
                loadVocabSets();
                showToast('K·∫øt n·ªëi Firebase th√†nh c√¥ng!', 'success');
            } else {
                showToast('L·ªói k·∫øt n·ªëi Firebase! Ki·ªÉm tra l·∫°i th√¥ng tin.', 'error');
            }
        }
        
        function switchToLocal() {
            useFirebase = false;
            db = null;
            localStorage.setItem('storageMode', 'local');
            localStorage.removeItem('firebaseConfig');
            
            // Delete Firebase app if exists
            if (firebase.apps.length) {
                firebase.apps.forEach(app => app.delete());
            }
            
            hideConfigModal();
            document.getElementById('config-section').classList.add('hidden');
            updateStorageStatus('connected', 'üíæ Local Storage - Ch·ªâ thi·∫øt b·ªã n√†y');
            loadVocabSets();
            showToast('ƒê√£ chuy·ªÉn sang Local Storage!', 'success');
        }
        
        function resetAllConfig() {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ c·∫•u h√¨nh?\n\nL∆∞u √Ω: D·ªØ li·ªáu tr√™n Firebase s·∫Ω KH√îNG b·ªã x√≥a, ch·ªâ x√≥a c·∫•u h√¨nh k·∫øt n·ªëi tr√™n thi·∫øt b·ªã n√†y.')) {
                return;
            }
            
            // Clear all local config
            localStorage.removeItem('firebaseConfig');
            localStorage.removeItem('storageMode');
            
            // Delete Firebase app
            if (firebase.apps.length) {
                firebase.apps.forEach(app => app.delete());
            }
            
            useFirebase = false;
            db = null;
            vocabSets = [];
            activeSetId = null;
            
            hideConfigModal();
            
            // Show config section again
            document.getElementById('config-section').classList.remove('hidden');
            document.getElementById('sets-section').classList.add('hidden');
            document.getElementById('flashcard-section').classList.add('hidden');
            document.getElementById('empty-state').classList.add('hidden');
            
            updateStorageStatus('disconnected', '‚öôÔ∏è C·∫ßn c·∫•u h√¨nh');
            showToast('ƒê√£ x√≥a c·∫•u h√¨nh!', 'success');
        }

        // ==================== STORAGE FUNCTIONS ====================
        async function saveToStorage(key, data) {
            if (useFirebase && db) {
                try {
                    await db.ref('vocabSets/' + key).set(data);
                    return true;
                } catch (error) {
                    console.error('Firebase save error:', error);
                    showToast('L·ªói l∆∞u d·ªØ li·ªáu!', 'error');
                    return false;
                }
            } else {
                try {
                    localStorage.setItem('vocab_' + key, JSON.stringify(data));
                    return true;
                } catch (error) {
                    console.error('LocalStorage save error:', error);
                    showToast('L·ªói l∆∞u d·ªØ li·ªáu!', 'error');
                    return false;
                }
            }
        }

        async function deleteFromStorage(key) {
            if (useFirebase && db) {
                try {
                    await db.ref('vocabSets/' + key).remove();
                    return true;
                } catch (error) {
                    console.error('Firebase delete error:', error);
                    return false;
                }
            } else {
                localStorage.removeItem('vocab_' + key);
                return true;
            }
        }

        async function loadVocabSets() {
            updateStorageStatus('syncing', 'üîÑ ƒêang t·∫£i d·ªØ li·ªáu...');
            
            if (useFirebase && db) {
                try {
                    const snapshot = await db.ref('vocabSets').once('value');
                    const data = snapshot.val();
                    vocabSets = data ? Object.values(data).sort((a, b) => b.id - a.id) : [];
                    updateStorageStatus('connected', '‚òÅÔ∏è Firebase Cloud - ƒê·ªìng b·ªô m·ªçi thi·∫øt b·ªã');
                } catch (error) {
                    console.error('Firebase load error:', error);
                    vocabSets = [];
                    updateStorageStatus('disconnected', '‚ùå L·ªói k·∫øt n·ªëi Firebase');
                }
            } else {
                vocabSets = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('vocab_')) {
                        try {
                            const data = JSON.parse(localStorage.getItem(key));
                            vocabSets.push(data);
                        } catch (e) {}
                    }
                }
                vocabSets.sort((a, b) => b.id - a.id);
                updateStorageStatus('connected', 'üíæ Local Storage - Ch·ªâ thi·∫øt b·ªã n√†y');
            }
            
            renderVocabSets();
            document.getElementById('loading').classList.add('hidden');
        }

        // ==================== UI FUNCTIONS ====================
        function updateStorageStatus(status, text) {
            const badge = document.getElementById('storage-status');
            const dot = badge.querySelector('.dot');
            const span = badge.querySelector('span:last-child');
            
            badge.className = 'storage-badge ' + status;
            dot.className = 'dot ' + status;
            span.textContent = text;
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type;
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        function showUpload() {
            document.getElementById('upload-section').classList.remove('hidden');
            document.getElementById('flashcard-section').classList.add('hidden');
        }

        function hideUpload() {
            document.getElementById('upload-section').classList.add('hidden');
            document.getElementById('set-name').value = '';
            document.getElementById('excel-name').textContent = 'Ch·ªçn file .xlsx';
            document.getElementById('audio-name').textContent = 'Ch·ªçn files .wav/.mp3';
            document.getElementById('excel-zone').classList.remove('has-file');
            document.getElementById('audio-zone').classList.remove('has-file');
            excelFile = null;
            audioFiles = [];
            
            if (activeSetId) {
                document.getElementById('flashcard-section').classList.remove('hidden');
            }
        }

        function renderVocabSets() {
            const container = document.getElementById('vocab-sets-list');
            const setsSection = document.getElementById('sets-section');
            const emptyState = document.getElementById('empty-state');
            
            if (vocabSets.length === 0) {
                setsSection.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            setsSection.classList.remove('hidden');
            
            container.innerHTML = vocabSets.map(set => `
                <div class="vocab-set-card ${set.id === activeSetId ? 'active' : ''}" onclick="selectSet(${set.id})">
                    <div class="vocab-set-header">
                        <div class="vocab-set-name">${set.name}</div>
                        <button class="btn btn-danger" onclick="event.stopPropagation(); deleteSet(${set.id})">üóëÔ∏è</button>
                    </div>
                    <div class="vocab-set-count">${set.words.length} t·ª´ v·ª±ng</div>
                </div>
            `).join('');
        }

        // ==================== VOCAB SET FUNCTIONS ====================
        function handleExcelSelect(input) {
            if (input.files[0]) {
                excelFile = input.files[0];
                document.getElementById('excel-name').textContent = excelFile.name;
                document.getElementById('excel-zone').classList.add('has-file');
                
                if (!document.getElementById('set-name').value) {
                    document.getElementById('set-name').value = excelFile.name.replace(/\.(xlsx|xls)$/, '');
                }
            }
        }

        function handleAudioSelect(input) {
            if (input.files.length > 0) {
                audioFiles = Array.from(input.files);
                document.getElementById('audio-name').textContent = `${audioFiles.length} files ƒë√£ ch·ªçn`;
                document.getElementById('audio-zone').classList.add('has-file');
            }
        }

        async function createVocabSet() {
            const setName = document.getElementById('set-name').value.trim();
            
            if (!setName || !excelFile || audioFiles.length === 0) {
                showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'error');
                return;
            }

            updateStorageStatus('syncing', 'üîÑ ƒêang t·∫°o b·ªô t·ª´...');

            try {
                const data = await readExcelFile(excelFile);
                const words = [];

                for (let i = 1; i < data.length; i++) {
                    const row = data[i];
                    if (row[0]) {
                        const audioFileName = `tu_${String(i).padStart(3, '0')}.wav`;
                        const audioFile = audioFiles.find(f => 
                            f.name === audioFileName || 
                            f.name === audioFileName.replace('.wav', '.mp3') ||
                            f.name === `tu_${String(i).padStart(3, '0')}.mp3`
                        );
                        
                        let audioData = null;
                        if (audioFile) {
                            audioData = await readFileAsDataURL(audioFile);
                        }

                        words.push({
                            id: i,
                            english: row[1] || '',
                            pos: row[2] || '',
                            pronunciation: row[3] || '',
                            vietnamese: row[4] || '',
                            audioData: audioData
                        });
                    }
                }

                const newSet = {
                    id: Date.now(),
                    name: setName,
                    words: words,
                    createdAt: new Date().toISOString()
                };

                const saved = await saveToStorage(newSet.id, newSet);
                
                if (saved) {
                    vocabSets.unshift(newSet);
                    renderVocabSets();
                    selectSet(newSet.id);
                    hideUpload();
                    showToast('T·∫°o b·ªô t·ª´ th√†nh c√¥ng!', 'success');
                }
            } catch (error) {
                console.error('Create error:', error);
                showToast('C√≥ l·ªói x·∫£y ra: ' + error.message, 'error');
                updateStorageStatus('connected', useFirebase ? '‚òÅÔ∏è Firebase Cloud' : 'üíæ Local Storage');
            }
        }

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function deleteSet(setId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b·ªô t·ª´ n√†y?')) return;
            
            updateStorageStatus('syncing', 'üîÑ ƒêang x√≥a...');
            
            const deleted = await deleteFromStorage(setId);
            if (deleted) {
                vocabSets = vocabSets.filter(s => s.id !== setId);
                if (activeSetId === setId) {
                    activeSetId = null;
                    document.getElementById('flashcard-section').classList.add('hidden');
                }
                renderVocabSets();
                showToast('ƒê√£ x√≥a b·ªô t·ª´!', 'success');
            }
            
            updateStorageStatus('connected', useFirebase ? '‚òÅÔ∏è Firebase Cloud - ƒê·ªìng b·ªô m·ªçi thi·∫øt b·ªã' : 'üíæ Local Storage - Ch·ªâ thi·∫øt b·ªã n√†y');
        }

        function selectSet(setId) {
            activeSetId = setId;
            currentIndex = 0;
            isFlipped = false;
            
            renderVocabSets();
            updateFlashcard();
            
            document.getElementById('flashcard-section').classList.remove('hidden');
            document.getElementById('upload-section').classList.add('hidden');
        }

        // ==================== FLASHCARD FUNCTIONS ====================
        function updateFlashcard() {
            const set = vocabSets.find(s => s.id === activeSetId);
            if (!set || !set.words.length) return;
            
            const word = set.words[currentIndex];
            
            document.getElementById('fc-english').textContent = word.english;
            document.getElementById('fc-english-back').textContent = word.english;
            document.getElementById('fc-pos').textContent = word.pos ? `(${word.pos})` : '';
            document.getElementById('fc-pos-back').textContent = word.pos ? `(${word.pos})` : '';
            document.getElementById('fc-pronunciation').textContent = word.pronunciation || '';
            document.getElementById('fc-pronunciation-back').textContent = word.pronunciation || '';
            document.getElementById('fc-vietnamese').textContent = word.vietnamese;
            
            document.getElementById('progress-badge').textContent = `${currentIndex + 1} / ${set.words.length}`;
            
            document.getElementById('btn-prev').disabled = currentIndex === 0;
            document.getElementById('btn-next').disabled = currentIndex === set.words.length - 1;
            
            // Reset flip
            document.getElementById('flashcard').classList.remove('flipped');
            isFlipped = false;
        }

        function flipCard() {
            isFlipped = !isFlipped;
            document.getElementById('flashcard').classList.toggle('flipped', isFlipped);
        }

        function prevWord() {
            if (currentIndex > 0) {
                currentIndex--;
                updateFlashcard();
            }
        }

        function nextWord() {
            const set = vocabSets.find(s => s.id === activeSetId);
            if (set && currentIndex < set.words.length - 1) {
                currentIndex++;
                updateFlashcard();
            }
        }

        function playAudio() {
            const set = vocabSets.find(s => s.id === activeSetId);
            const word = set?.words[currentIndex];
            
            if (word?.audioData) {
                audioElement.src = word.audioData;
                audioElement.play().catch(e => {
                    showToast('Kh√¥ng th·ªÉ ph√°t √¢m thanh!', 'error');
                });
            } else {
                showToast('Kh√¥ng c√≥ file √¢m thanh!', 'error');
            }
        }

        // ==================== KEYBOARD NAVIGATION ====================
        document.addEventListener('keydown', (e) => {
            if (!activeSetId) return;
            
            switch(e.key) {
                case 'ArrowLeft':
                    prevWord();
                    break;
                case 'ArrowRight':
                    nextWord();
                    break;
                case ' ':
                case 'Enter':
                    e.preventDefault();
                    flipCard();
                    break;
                case 'p':
                case 'P':
                    playAudio();
                    break;
            }
        });

        // ==================== INITIALIZATION ====================
        window.onload = function() {
            const savedConfig = localStorage.getItem('firebaseConfig');
            const storageMode = localStorage.getItem('storageMode');
            
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    if (initFirebase(config)) {
                        loadVocabSets();
                        return;
                    }
                } catch (e) {
                    console.error('Config parse error:', e);
                }
            }
            
            if (storageMode === 'local') {
                useFirebase = false;
                updateStorageStatus('connected', 'üíæ Local Storage - Ch·ªâ thi·∫øt b·ªã n√†y');
                loadVocabSets();
                return;
            }
            
            // Show config section
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('config-section').classList.remove('hidden');
            updateStorageStatus('disconnected', '‚öôÔ∏è C·∫ßn c·∫•u h√¨nh Firebase');
        };
    </script>
</body>
</html>